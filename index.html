<!DOCTYPE HTML>
<html>
<head>
	<title>Hello World</title>
	
	<style>
	#template{
			display: none;
	}
	</style>
</head>
<body>
	<h1>Hello World</h1>
	<div id='wrapper'>
	<input type='button' class='readView' value='Read' /> <input type='button' class='createView' value='Create' />
	<h2>View Data</h2>
	<div id='container'></div>
	</div>
	<script src='js/jquery.js'></script>
	<script src='js/underscore-min.js'></script>
	<script src='js/backbone.js'></script>
	<script>

	var getQuery=function(query){
		var queryStr='';
		for(var i in query){
			if(typeof query[i] == 'undefined') continue;
			if(queryStr !== '') queryStr+='&';
			queryStr+=i+'='+query[i];
		}
		return queryStr;
	};	
	(function($){
	jQuery.fn.serializeObject=function() {
		var arrayData, objectData;
		arrayData=this.serializeArray();
		objectData={};
		$.each(arrayData, function(){
			var value;
			if(this.value != null){
				value=this.value;
			} else{
				value='';
			}
			if(objectData[this.name] != null) {
				if(!objectData[this.name].push) {
					objectData[this.name]=[objectData[this.name]];
				}
				objectData[this.name].push(value);
			} else {
				objectData[this.name]=value;
			}
		});
		return objectData;
	};	
	var Student={};
	Student.View={};
	Student.Model=Backbone.Model.extend({
		initialize: function(){

		},
		defaults: {
			'id': 'underfind',
			'nickname': 'underfind'
		},
		urlRoot: 'mysql.php',
		url: function(){
			queryStr=getQuery(this.query);
			var base=this.urlRoot || (this.collection && this.collection.url) || '/';
			if (this.isNew()) return base;
			console.log('act: '+base+'?'+queryStr);
			return base+'?'+queryStr;
		}
	});
	Student.Collection=Backbone.Collection.extend({
		model: Student.Model,
		initialize: function(arr, query){
			this.query=query;
			console.log('Collection');
		},
		comparator: function(model){
			return model.get();
		}
	});
	Student.View.Create=Backbone.View.extend({
		el: $('#wrapper'),
		template: 'create.html',
		events: {
			"click .createView": "view",
			"click .submit": "submit"
		},	
		view: function(e){
			console.log('show');
			$('#container').load(this.template);
		},	
		submit: function(e){
			console.log('Submit');
			e.preventDefault();
			var data=this.$el.find('form').serializeObject();
			this.model.query={'act':'create'}
			this.model.save(data);
			return false;
		}
	});	
	Student.View.Update=Backbone.View.extend({
		el: $('#wrapper'),
		container: $('#container'),
		template: 'update.html',
		events: {
			"click .updateView": "view",
			"click .updateSubmit": "submit"
		},
		view: function(e){
			console.log('---------- Student.View Update ----------');
			console.log('View');
			var self=this;
			this.container.load(this.template, function(html){
				self.container.html('');
				self.container.html(_.template(html, self.model.toJSON())+self.container.html());
			});
			return false;
		},	
		submit: function(e){
			console.log('Submit');
			e.preventDefault();
			var data=this.$el.find('form').serializeObject();
			this.model.query={'act':'update'}	
			this.model.save(data);
			return false;
		}
	});	
	Student.View.Read=Backbone.View.extend({
		el: $('#wrapper'),
		container: $('#container'),
		collection: new Student.Collection(),
		template: 'item.html',
		templateUpdate: 'update.html',
		query: {'act':'read'},
		events: {
			"click .readView": "render",
			"click .updateView": "update",
			"click .delete": "delete"
		},
		initialize: function(collection, query){
			console.log('---------- Student.View Read ----------');
			console.log('Initialize');
			var queryStr=getQuery(this.query);
			console.log(queryStr);
			this.collection.url='mysql.php?'+queryStr;
			this.render();
		},
		render: function(){
			console.log('Render');
			this.read();
		},
		delete: function(e){
			var id=e.currentTarget.getAttribute('data-id');
			var model=this.collection.get(id);
			model.query={'act': 'delete'};
			model.data={'id': id};
   			model.save(model.query);
		},
		update: function(e){
			console.log('Update');
			var self=this, id=e.currentTarget.getAttribute('data-id'), model=self.collection.get(id);
			this.container.load(this.templateUpdate, function(html){
				self.container.html('');
				self.container.html(_.template(html, model.toJSON())+self.container.html());
			});
			return false;
		},
		read: function(){
			console.log(this.container);
			var self=this;
			self.container.load(this.template, function(html){
				self.container.html('');
				self.collection.on("add change", 
					function(model){
						console.log('counter');
						self.container.html(_.template(html, model.toJSON())+self.container.html());
					}, this
				);
				self.collection.fetch();
			});
		}
	});

	Student.Router=Backbone.Router.extend({
		routes: {
			'': 'default',
			'act=:act/id=:id': 'default'
		},
		default: function(act, id){
			var collection=new Student.Collection();
			new Student.View.Read({collection: collection});
			var model=new Student.Model();
			new Student.View.Create({model: model});
		}
	})
	var appRouter=new Student.Router();
	Backbone.history.start();
	})(jQuery);

   </script> 
</body>
</html>
 