<!DOCTYPE HTML>
<html>
<head>
	<title>Hello World</title>
</head>
<body>
	<h1>Hello World CRUD</h1>
	<div id='wrapper'>
	<input type='button' class='mainView' value='Main' /> <input type='button' class='createView' value='Create' /> <input type='button' class='save' value='Save' />
	<h2>Container</h2>
	<div id='container'></div>
	<div id='page-wrapper'>
		<h2>Page</h2>
		<div id='page-container'></div>
	</div>
	</div>
	<script src='js/jquery.js'></script>
	<script src='js/underscore-min.js'></script>
	<script src='js/backbone.js'></script>
	<script>
	(function($){
	var getQuery=function(query){
		var queryStr='';
		for(var i in query){
			if(typeof query[i] == 'undefined') continue;
			if(queryStr !== '') queryStr+='&';
			queryStr+=i+'='+query[i];
		}
		return queryStr;
	};		
	jQuery.fn.serializeObject=function() {
		var arrayData, objectData;
		arrayData=this.serializeArray();
		objectData={};
		$.each(arrayData, function(){
			var value;
			if(this.value != null){
				value=this.value;
			} else{
				value='';
			}
			if(objectData[this.name] != null) {
				if(!objectData[this.name].push) {
					objectData[this.name]=[objectData[this.name]];
				}
				objectData[this.name].push(value);
			} else {
				objectData[this.name]=value;
			}
		});
		return objectData;
	};	
	var Student={};
	Student.View={};
	Student.Model=Backbone.Model.extend({
		initialize: function(collection, query){
			console.log('Model Initialize');
		},
		defaults: {
			'id': 'underfind',
			'nickname': 'underfind'
		},
		urlRoot: 'mysql.php',
		url: function(){
			var base=this.urlRoot || (this.collection && this.collection.url) || '/', query=getQuery(this.query)
			if (this.isNew()) return base;
			return base+'?'+query;
		}
	});
	Student.Collection=Backbone.Collection.extend({
		initialize: function(){
			console.log('Collection Initialize');
		},
		model: Student.Model,
		comparator: function(model){
			return model.get();
		}
	});
	Student.View.Read=Backbone.View.extend({
		el: $('#wrapper'),
		container: $('#container'),
		template: 'main.html',
		templateRead: 'read.html',
		templateUpdate: 'update.html',
		templateCreate: 'create.html',
		query: {'act': 'read'},
		page: {
			el: $('#page-wrapper'),			
			container: $('#page-container'),
			template: 'page.html',
			max: 5,
			current: 1
		},
		history: [],
		events: {
			"click .save": "save",
			"click .mainView": "render",
			// Page //
			"click .pageView": "render",
			// Read //
			"click .readView": "readView",
			// Create //
			"click .createView": "createView",
			"click .createSubmit": "createSubmit",
			// Update //
			"click .updateView": "updateView",
			"click .updateSubmit": "updateSubmit",
			"click .deleteSubmit": "deleteSubmit"
		},
		initialize: function(collection, query){
			console.log('View- Initialize');
			var that=this, query=getQuery(this.query);
			this.collection.url='mysql.php?'+query;
			that.collection.fetch({
				success: function(collection, resp){
					that.render();
				}
			});
		},
		render: function(evt){
			console.log('View- Render');
			this.page.current=evt?(evt.currentTarget.getAttribute('data-page')?evt.currentTarget.getAttribute('data-page'):1):1;
			var that=this, pageStart=(that.page.current-1)*that.page.max, pageEnd=pageStart+that.page.max;
			this.container.load(this.template, function(html){
				that.container.html('');
				for(var i=pageStart; i < pageEnd; i++){
					if(!(that.collection).models[i]) break;
					that.container.html(that.container.html()+_.template(html, (that.collection).models[i].toJSON()));
				}
			});
			// Page //
			var pageCounter=Math.ceil(((this.collection).models.length)/this.page.max);
			console.log(pageCounter);
			this.page.container.load(this.page.template, function(html){
				that.page.container.html('');
				for(var i=1; i <= pageCounter; i++){
					that.page.container.html(that.page.container.html()+_.template(html, {page: i}));
				}
			});	
			return false;		
		},
		createView: function(evt){
			console.log('View- Create');
			evt.preventDefault();
			this.container.load(this.templateCreate);
			return false;
		},
		createSubmit: function(evt){
			console.log('View- Create- Submit');
			evt.preventDefault();
			var model=this.model, query={'act': 'create'}, data=this.$el.find('form').serializeObject();
			// Request Client //
			this.collection.add(data);
			// Save History //
			this.history.push({'model':model, 'query':query, 'data':data});	
			// Request Server //			
			//this.request(model, query, data);
			this.render();
		},
		readView: function(evt){
			console.log('View- Read');
			evt.preventDefault();
			var that=this, id=evt.currentTarget.getAttribute('data-id'), model=that.collection.get(id);
			this.container.load(this.templateRead, function(html){
				that.container.html('');
				that.container.html(_.template(html, model.toJSON())+that.container.html());
			});
			return false;
		},
		updateView: function(evt){
			console.log('View- Update');
			evt.preventDefault();
			var that=this, id=evt.currentTarget.getAttribute('data-id'), model=that.collection.get(id);
			this.container.load(this.templateUpdate, function(html){
				that.container.html('');
				that.container.html(_.template(html, model.toJSON())+that.container.html());
			});
			return false;
		},
		updateSubmit: function(evt){
			console.log('View- Update- Submit');
			evt.preventDefault();
			var query={'act':'update'}, data=this.$el.find('form').serializeObject(), model=this.collection.get(data.id);
			console.log(model);
			// Request Client //			
			model.set(data);
			// Save History //			
			this.history.push({'model':model, 'query':query, 'data':data});	
			// Request Server //			
			//this.request(model, query, data);
			this.render();
		},
		request: function(model, query, data){
			console.log('View- Request');
			console.dir(model);
			this.model.query=query;
			this.model.save(data);
		},
		save: function(){
			console.log('View- Save');
			for(var i in this.history){
				console.dir(this.history[i]);
				this.request(this.history[i].model, this.history[i].query, this.history[i].data);
			}
			this.initialize();
		},	
		deleteSubmit: function(evt){
			console.log('View- Delete');
			evt.preventDefault();
			var id=evt.currentTarget.getAttribute('data-id'), model=this.collection.get(id), query={'act': 'delete'}, data={'id': id};
			// Request Client //
			model.destroy();
			// Save History //
			this.history.push({'model':model, 'query':query, 'data':data});		
			// Request Server //			
			//this.request(model, query, data);
			this.render();
		}
	});
	Student.Router=Backbone.Router.extend({
		routes: {
			'': 'default',
			'act=:act/id=:id': 'default'
		},
		'default': function(act, id){
			var collection=new Student.Collection();
			var model=new Student.Model();
			new Student.View.Read({collection: collection, model: model});
		}
	})
	var appRouter=new Student.Router();
	Backbone.history.start();
	})(jQuery);

   </script> 
</body>
</html>
 